<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
       "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
<% if controller.action_name == 'view' %>
  <meta http-equiv="refresh" content="15" />
<% end %>
  <title>Yksiköt: <%= controller.action_name %></title>
  <%= stylesheet_link_tag 'scaffold' %>
  <%= stylesheet_link_tag 'flexselect' %>
  <%= javascript_include_tag "application" %>
  <%= csrf_meta_tags %>
<% if @unit %>
<%= yield  %>
<% end %>
<% if @operation && @operation.zoom != nil && @operation.zoom.length > 0 %>
  <script type="text/javascript" charset="utf-8" src="/javascripts/OpenLayers/OpenLayers.js"></script>
  <script type="text/javascript" charset="utf-8" src="http://mapstraction.com/mapstraction-js/mapstraction.js"></script>
  <script type="text/javascript" charset="utf-8" src="http://mapstraction.com/mapstraction-js/mapstraction-geocode.js"></script>
  <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key=ABQIAAAAHbkHfRKyUGRnWAIcORhKUBRJ5fC-ru0-Inech0mr5WHsw_sdvhQ7ul2gxt1BsgCBQ9GneVu-qRUJPA" type="text/javascript"></script>
  <script type="text/javascript">
    var mapstraction;
    var geocoder;
    var name;
    var details;

    function initialize() {
      initializeGoogleMap();
      //initializeMapstraction();
    }

    function unload() {
      GUnload();
    }

    function initializeMapstraction() {
      mapstraction = new mxn.Mapstraction('map_canvas','google');
      mapstraction.setCenterAndZoom(new mxn.LatLonPoint(<%= @operation.latitude %>, <%= @operation.longitude %>), <%= @operation.zoom %>);
      geocoder = new MapstractionGeocoder(geocode_return, 'google');
<% for unit in @units %>
      name = "<%= unit.unit %>";
      details = "<%= unit.details %>";
      var address = new Object();
      address.street = "<%= unit.location %>";
      address.locality = "Helsinki";
      address.region = "FI";
      address.country = "FI";
      geocoder.geocode( address );
<% end %>
    }

    function geocode_return(geocoded_location) {
      advancedMarker( name, details, geocoded_location.latitude, geocoded_location.longitude);
    }

    function advancedMarker(name, description, lat, lon) {
      mapstraction.addMarkerWithData(new mxn.Marker( new mxn.LatLonPoint(lat,lon)),{
        infoBubble : description,
        label : name,
        date : "new Date()",
        marker : 4,
        iconShadow: "http://mapufacture.com/images/providers/blank.png",
        iconShadowSize : [0,0],
        icon : "/images/green.png",
        iconSize : [40,40],
        draggable : false,
        hover : true
      });
    }

    function initializeGoogleMap() {
      if (GBrowserIsCompatible()) {
        var baseIcon = new GIcon(G_DEFAULT_ICON);
        baseIcon.image = "/images/white.png";
        baseIcon.iconSize = new GSize(22, 22);

        var geocoder = new GClientGeocoder();
        var map = new GMap2(document.getElementById("map_canvas"));
        map.setCenter(new GLatLng(<%= @operation.latitude %>, <%= @operation.longitude %>), <%= @operation.zoom %>);
        map.setUIToDefault();
<% for unit in @units %>
        geocoder.getLatLng(
          "<%= unit.location %><%= @operation.postfix %>",
          function(point) {
            if (point) {
<% if unit.state != nil && ( unit.state.id == 1 || unit.state.id == 7 ) %>
              baseIcon.image = "/images/green.png";
<% end %>
<% if unit.state != nil && unit.state.id == 2 %>
              baseIcon.image = "/images/yellow.png";
<% end %>
<% if unit.state != nil && ( unit.state.id == 3 || unit.state.id == 4 ) %>
              baseIcon.image = "/images/red.png";
<% end %>
<% if unit.state != nil && ( unit.state.id == 5 || unit.state.id == 6 ) %>
              baseIcon.image = "/images/pink.png";
<% end %>
<% if unit.state != nil && ( unit.state.id == 8 || unit.state.id == 9 ) %>
              baseIcon.image = "/images/blue.png";
<% end %>
              var marker = new GMarker(point, {icon:baseIcon, title:"<%= unit %> <%= unit.state %> <%= unit.currentcode %> <%= unit.currentmessage %>"});
              map.addOverlay(marker);
            }
          }
        );
<% end %>
<% if @queue %>
<% for queue in @queue %>
        geocoder.getLatLng(
          "<%= queue.location %><%= @operation.postfix %>",
          function(point) {
            if (point) {
              baseIcon.image = "/images/queue.png";
              var marker = new GMarker(point, {icon:baseIcon, title:"<%= queue.message %> <%= queue.code %>"});
              map.addOverlay(marker);
            }
          }
        );
<% end %>
<% end %>

      }
    }

  </script>
<% end %>
</head>

<% if @operation && @operation.zoom && @operation.zoom.length > 0 %>
<body onload="initialize()" onunload="unload()">
    <div id="map_canvas" style="width: <%= @operation.width %>px; height: <%= @operation.height %>px"></div>
<% else %>
<body>
<% if @operation && @operation.map && @operation.map.length > 0 %>
<div id="image"><img width="<%= @operation.width %>" height="<%= @operation.height %>" src="<%= @operation.map %>" />
<% for unit in @units %>
<% if unit.location && unit.location.x %>
<div style="position: absolute; top: <%= unit.location.y %>px; left: <%= unit.location.x %>px;"><p><%= unit.coloredname %></p></div>
<% end %>
<% end %>
</div>
<% end %>
<% end %>

<p style="color: green"><%= flash[:notice] %></p>
<% if ! @unit %>
<%= yield  %>

<p>
<%= link_to 'Tilannekuva syötöllä', units_path %>
<%= link_to 'Tilannekuva', '/units/view/1' %>
<%= link_to 'Tapahtumat', events_path %>
<%= link_to 'Uusi tapahtuma', new_event_path %>
<%= link_to 'Yksiköiden hallinta', '/units/available/1' %>
<%= link_to 'Uusi yksikkö', new_unit_path %>
<%= link_to 'Koodit', codes_path %>
</p>
<% end %>
</body>
</html>
